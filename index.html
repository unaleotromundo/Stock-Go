<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editor Canvas Pro v2.0</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Bebas+Neue&family=Anton&family=Lobster&family=Oswald&family=Poppins&family=Playfair+Display:wght@700&family=Permanent+Marker&family=Rock+Salt&family=Luckiest+Guy&family=Shadows+Into+Light&family=Orbitron:wght@900&family=Archivo+Black&family=Quicksand:wght@700&family=Arizonia&family=Bangers&family=Covered+By+Your+Grace&family=Fredericka+the+Great&family=Indie+Flower&family=Pacifico&family=Press+Start+2P&family=Gloria+Hallelujah&family=Rammetto+One&family=Monoton&family=Rubik+Moonrocks&family=Special+Elite&family=Amatic+SC:wght@700&family=VT323&family=Chewy&family=Black+Ops+One&family=Faster+One&family=Acme&family=Rye&family=Rubik+80s+Fade&family=Sigmar+One&family=UnifrakturCook&family=Sacramento&family=Chango&family=Major+Mono+Display&family=IBM+Plex+Mono:wght@700&family=Poiret+One&family=Unbounded:wght@700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --c-cyan: #00B4D8;
  --c-magenta: #D0006F;
  --c-yellow: #FFD166;
  --c-key: #073B4C;
  --surface: rgba(255, 255, 255, 0.92);
  --border: rgba(0, 0, 0, 0.08);
  --text: #0f172a;
  --text-secondary: #64748b;
  --shadow: 0 4px 24px rgba(0,0,0,0.05);
  --shadow-active: 0 6px 32px rgba(0,0,0,0.12);
  --panel-bg: rgba(255, 255, 255, 0.85);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Montserrat', sans-serif;
  background: linear-gradient(135deg, #fbfcfd 0%, #f6f9fb 100%);
  min-height: 100vh;
  color: var(--text);
  overflow: hidden;
  touch-action: none;
}

header {
  display: flex;
  overflow-x: auto;
  gap: 6px;
  padding: 8px;
  background: var(--panel-bg);
  backdrop-filter: blur(12px);
  box-shadow: var(--shadow);
  z-index: 100;
  scrollbar-width: none;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
}

header::-webkit-scrollbar { display: none; }

.icon-btn {
  flex: 0 0 auto;
  width: 54px;
  height: 54px;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.05), inset 0 0 10px rgba(255,255,255,0.5);
  cursor: pointer;
  border: 1px solid transparent;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}

.icon-btn.active {
    border-color: var(--c-cyan);
    box-shadow: 0 0 0 2px var(--c-cyan), inset 0 2px 4px rgba(0,0,0,0.1);
}

.icon-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #f8f9fa;
}
#undoBtn svg path, #redoBtn svg path {
    fill: #333;
    stroke: #333;
}
body.dark #undoBtn svg path, body.dark #redoBtn svg path {
    fill: #f1f5f9;
    stroke: #f1f5f9;
}


#zoomModeBtn svg path {
    fill: #333;
    stroke: #333;
}
body.dark #zoomModeBtn svg path {
    fill: #f1f5f9;
    stroke: #f1f5f9;
}

#bgColorBtn { background: var(--c-cyan); }
#addTextBtn { background: var(--c-magenta); }
#addImageBtn { background: var(--c-yellow); }
#generateQrBtn { background: var(--c-key); }
#exportBtn { background: #E9ECEF; }
#clearCanvasBtn { background: #3db52d; }

.icon-btn::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 100%;
  background: linear-gradient(rgba(255,255,255,0.2), transparent);
  pointer-events: none;
}

.icon-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15), inset 0 -2px 0 rgba(0,0,0,0.05), inset 0 0 10px rgba(255,255,255,0.5); }
.icon-btn:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.05), inset 0 0 10px rgba(255,255,255,0.5); }

.icon-btn svg { width: 24px; height: 24px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
.icon-btn svg path, .icon-btn svg rect, .icon-btn svg circle { fill: #fff; stroke: #fff; }
#exportBtn .icon-label, #clearCanvasBtn .icon-label, #undoBtn .icon-label, #redoBtn .icon-label { color: var(--text); text-shadow: none; }
.icon-label { font-size: 9px; font-weight: 600; margin-top: 4px; text-align: center; color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.3); }

main {
  position: fixed;
  top: 70px;
  left: 0;
  right: 0;
  bottom: 38px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #f0f4f8;
}

.canvas-wrapper {
    position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.canvas-wrapper > canvas, .canvas-wrapper .canvas-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
#backgroundCanvas {
    border: 1px solid #e2e8f0;
    z-index: 1;
}
.canvas-container {
    z-index: 2;
}
body.dark #backgroundCanvas {
    border: 1px solid #334155;
}

.floating-tools {
  position: absolute;
  top: 20px;
  right: 20px;
  background: var(--panel-bg);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column; 
  gap: 6px;
  padding: 8px;
  border: 1px solid var(--border);
  z-index: 10;
  cursor: move;
  user-select: none;
  flex-wrap: wrap; 
}

.floating-tools button { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; border: none; font-size: 16px; transition: all 0.2s ease; }
.floating-tools button:hover { background: #f1f5f9; }
#generalTools, #textTools, #imageTools { display: flex; gap: 6px; background: #fff; padding: 6px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }

.popup { display: none; position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: center; justify-content: center; padding: 16px; }
.popup-content { background: var(--panel-bg); padding: 24px; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); backdrop-filter: blur(20px); border: 1px solid var(--border); display: flex; flex-direction: column; }
.popup-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--text); text-align: center; position: relative; padding-bottom: 12px; }
.popup-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 60px; height: 3px; background: linear-gradient(90deg, var(--c-cyan), var(--c-magenta)); border-radius: 3px; }
.image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px; flex-grow: 1; }
.image-thumb { width: 100%; height: 100px; object-fit: cover; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s ease; background-color: #e2e8f0; }
.image-thumb:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
.popup-close { width: 100%; padding: 14px; background: var(--c-key); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; transition: background 0.2s; margin-top: 10px; }
.popup-close:hover { background: #052a39; }

.font-selector { max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 10px; background: #fff; padding: 8px; display: grid; gap: 8px; margin-bottom: 16px; }
.font-option { padding: 12px; border-radius: 8px; background: #f8fafc; cursor: pointer; font-size: 16px; border: 1px solid transparent; transition: all 0.15s ease; text-align: center; font-weight: 500; }
.font-option:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.06); }
.font-option.selected { background: var(--c-cyan); color: #fff; border-color: rgba(0,0,0,0.06); box-shadow: 0 4px 12px rgba(0, 180, 216, 0.3); }

footer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--panel-bg); backdrop-filter: blur(12px); padding: 8px 20px; font-size: 12px; color: var(--text-secondary); border-top: 1px solid var(--border); z-index: 90; display: flex; justify-content: space-between; align-items: center; height: 38px; }
.footer-links { display: flex; gap: 12px; }
.footer-links a { color: var(--text); text-decoration: none; transition: color 0.2s; font-weight: 500; font-size: 12px; }
.footer-links a:hover { color: var(--c-cyan); }

.help-message { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; z-index: 10; animation: fadeInOut 4s forwards; display: none; }
@keyframes fadeInOut { 0% { opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { opacity: 0; display: none; } }

@media (max-width: 768px) { .icon-btn { width: 48px; height: 48px; } .popup-content { padding: 16px; } .font-selector { max-height: 200px; } .floating-tools { top: 10px; right: 10px; transform: scale(0.9); } .icon-label { font-size: 8px; } footer { flex-direction: column; gap: 4px; padding: 6px; height: auto; } }
@media (max-width: 480px) { .icon-btn { width: 44px; height: 44px; } header { padding: 6px; gap: 4px; } .popup-title { font-size: 18px; } footer { flex-direction: column; gap: 4px; padding: 6px; } .footer-links { gap: 8px; } .icon-label { font-size: 7px; } }

.hidden-input { display: none; }
.upload-card { width: 100%; min-height: 100px; background-color: #f0f4f8; border: 2px dashed #94a3b8; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: #64748b; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s ease; margin-bottom: 20px; }
.upload-card:hover { background-color: #e2e8f0; border-color: #334155; color: #334155; }
.search-wrapper { display: flex; gap: 8px; margin-bottom: 20px; }
#imageSearchInput { flex-grow: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border); font-size: 16px; background: #999393; }
#imageSearchBtn { padding: 0 20px; background: var(--c-cyan); color: white; border: none; border-radius: 10px; cursor: pointer; transition: background .2s; }
#imageSearchBtn:hover { background: #0096b2; }

body.dark { --surface: rgba(15, 23, 42, 0.92); --border: rgba(255, 255, 255, 0.1); --text: #f1f5f9; --text-secondary: #94a3b8; --shadow: 0 4px 24px rgba(0,0,0,0.2); --shadow-active: 0 6px 32px rgba(0,0,0,0.3); --panel-bg: rgba(15, 23, 42, 0.85); background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
body.dark .icon-btn { background: linear-gradient(145deg, #1e293b, #0f172a); box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 -2px 0 rgba(0,0,0,0.1), inset 0 0 10px rgba(255,255,255,0.1); }
body.dark .icon-btn svg path, body.dark .icon-btn svg rect, body.dark .icon-btn svg circle { fill: #f1f5f9; stroke: #f1f5f9; }
body.dark .icon-label, body.dark #exportBtn .icon-label, body.dark , body.dark #clearCanvasBtn .icon-label, body.dark #undoBtn .icon-label, body.dark #redoBtn .icon-label { color: #f1f5f9; }
body.dark .canvas-wrapper { background: #1e293b; }
body.dark #backgroundCanvas { border: 1px solid #334155; }
body.dark .popup-content, body.dark .font-selector, body.dark .font-option { background: #1e293b; color: #f1f5f9; border-color: var(--border); }
body.dark .upload-card { background: #334155; border-color: #475569; color: #cbd5e1; }
body.dark .search-wrapper input { background: #334155; color: #f1f5f9; border-color: var(--border); }
#themeToggleBtn { background: linear-gradient(145deg, #0f172a, #1e293b); box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 -2px 0 rgba(0,0,0,0.1), inset 0 0 10px rgba(255,255,255,0.1); }
#themeToggleBtn svg path { fill: #f1f5f9; stroke: #f1f5f9; }
#themeToggleBtn .icon-label { color: #f1f5f9; }
body.dark #themeToggleBtn { background: linear-gradient(145deg, #ffffff, #f0f0f0); box-shadow: 0 4px 8px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.05), inset 0 0 10px rgba(255,255,255,0.5); }
body.dark #themeToggleBtn svg path { fill: #0f172a; stroke: #0f172a; }
body.dark #themeToggleBtn .icon-label { color: #0f172a; }
#exportBtn svg path { fill: #000000; stroke: #000000; }
#exportBtn .icon-label { color: #000000; }
body.dark #exportBtn svg path { fill: #000000; stroke: #000000; }
body.dark #exportBtn .icon-label { color: #000000; }

#resetViewBtn { position: absolute; bottom: 20px; right: 20px; z-index: 101; background: var(--panel-bg); backdrop-filter: blur(8px); border-radius: 20px; box-shadow: var(--shadow-active); border: 1px solid var(--border); padding: 8px 16px; font-size: 14px; font-weight: 600; color: var(--text); cursor: pointer; display: none; transition: opacity 0.3s, transform 0.3s; }
#resetViewBtn:hover { transform: scale(1.05); }

#dragDropOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 180, 216, 0.7); z-index: 9999; display: none; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; text-align: center; pointer-events: none; }
#dragDropOverlay::before { content: 'Suelta tu imagen aqu√≠'; padding: 20px; border: 3px dashed white; border-radius: 20px; }

#bgPopup .popup-options { display: flex; flex-direction:column; gap: 16px; margin-bottom: 24px; }
#bgPopup .popup-options > * { flex: 1; }
#pickColorBtn { width:100%; padding: 14px; background: var(--c-key); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; transition: background 0.2s; }
#pickColorBtn:hover { background: #052a39; }

#welcomeOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); z-index: 300; display: none; align-items: center; justify-content: center; padding: 20px; }
.welcome-content { background: var(--surface); color: var(--text); padding: 32px; border-radius: 24px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow-active); }
.welcome-content h1 { font-size: 28px; margin-bottom: 12px; }
.welcome-content > p { font-size: 16px; color: var(--text-secondary); margin-bottom: 28px; }
.tutorial-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; text-align: left; margin-bottom: 32px; }
.tutorial-item { display: flex; align-items: center; gap: 16px; }
.tutorial-item .icon-preview { flex-shrink: 0; width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
.tutorial-item .icon-preview svg { width: 24px; height: 24px; }
.tutorial-item strong { font-size: 16px; margin-bottom: 4px; color: var(--text); }
.tutorial-item p { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
.welcome-actions { display: flex; gap: 12px; justify-content: center; }
.welcome-actions button { padding: 12px 24px; font-size: 16px; font-weight: 600; border-radius: 12px; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
.welcome-actions button:hover { transform: translateY(-2px); box-shadow: var(--shadow-active); }
#showIdeasBtn { background-color: #E9ECEF; color: var(--c-key); }
#startEditingBtn { background-color: var(--c-cyan); color: white; }
#ideas-list { text-align: left; padding-left: 20px; line-height: 1.8; }
@media (max-width: 768px) { .welcome-content { padding: 24px; } .welcome-content h1 { font-size: 24px; } }

#tutorialBtn { position: absolute; bottom: 20px; left: 20px; width: 50px; height: 50px; border-radius: 50%; background-color: var(--c-magenta); color: white; border: none; font-size: 28px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 101; box-shadow: var(--shadow-active); transition: transform 0.2s; }
#tutorialBtn:hover { transform: scale(1.1); }
</style>
</head>
<body>

<div id="welcomeOverlay">
    <div class="welcome-content">
        <h1>¬°Bienvenido a Editor Canvas Pro!</h1>
        <p>Tu herramienta creativa para dise√±ar flyers de forma f√°cil y r√°pida. Aqu√≠ tienes una gu√≠a de las herramientas principales:</p>
        <div class="tutorial-grid">
            <div class="tutorial-item"> <div class="icon-preview" style="background-color: #E9ECEF;"><svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z" fill="#333" stroke="#333"/></svg></div> <div> <strong>Deshacer/Rehacer</strong> <p>Corrige errores f√°cilmente. Usa los botones o Ctrl+Z/Ctrl+Y para volver atr√°s o adelante.</p> </div> </div>
            <div class="tutorial-item"> <div class="icon-preview" style="background-color: #E9ECEF;"><svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.96 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z" fill="#333" stroke="#333"/></svg></div> <div> <strong>Adelante</strong> <p>Si deshiciste algo por error, puedes usar este bot√≥n o Ctrl+Y para rehacer la acci√≥n.</p> </div> </div>
            <div class="tutorial-item"> <div class="icon-preview" style="background-color: var(--c-cyan);"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div> <div> <strong>Fondo</strong> <p>Elige un color s√≥lido o selecciona un fondo de la galer√≠a para empezar.</p> </div> </div>
            <div class="tutorial-item"> <div class="icon-preview" style="background-color: var(--c-magenta);"><svg viewBox="0 0 24 24"><path d="M2.5 4v3h5v12h3V7h5V4h-13zm19 5h-9v3h3v7h3v-7h3V9z"/></svg></div> <div> <strong>Texto</strong> <p>A√±ade y personaliza texto. Ahora puedes ponerle un fondo de color para resaltarlo.</p> </div> </div>
            <div class="tutorial-item"> <div class="icon-preview" style="background-color: var(--c-yellow);"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 5c-3.86 0-7 3.14-7 7s3.14 7 7 7V5z"/></svg></div> <div> <strong>Imagen</strong> <p>Sube tus im√°genes, arr√°stralas al lienzo o busca en una galer√≠a gratuita.</p> </div> </div>
            <div class="tutorial-item"> <div class="icon-preview" style="background-color: var(--c-key);"><svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-6 8h8v-8h-8v8zm2-6h4v4h-4v-4z"/></svg></div> <div> <strong>C√≥digo QR</strong> <p>Genera un QR para tu WhatsApp y a√±√°delo a tu dise√±o para que te contacten f√°cilmente.</p> </div> </div>
        </div>
        <div class="welcome-actions"> <button id="showIdeasBtn">Ver Ideas</button> <button id="startEditingBtn">Empezar a Dise√±ar</button> </div>
    </div>
</div>

<header>
    <button class="icon-btn" title="Deshacer (Ctrl+Z)" id="undoBtn" disabled> <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg> <span class="icon-label">Atr√°s</span> </button>
    <button class="icon-btn" title="Rehacer (Ctrl+Y)" id="redoBtn" disabled> <svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.96 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg> <span class="icon-label">Rehacer</span> </button>
    <button class="icon-btn" title="Zoom" id="zoomModeBtn"> <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg> <span class="icon-label">Zoom</span> </button>
    <button class="icon-btn" title="Fondo" id="bgColorBtn"> <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg> <span class="icon-label">Fondo</span> </button>
    <button class="icon-btn" title="Agregar texto" id="addTextBtn"> <svg viewBox="0 0 24 24"><path d="M2.5 4v3h5v12h3V7h5V4h-13zm19 5h-9v3h3v7h3v-7h3V9z"/></svg> <span class="icon-label">Texto</span> </button>
    <button class="icon-btn" title="Agregar imagen" id="addImageBtn"> <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 5c-3.86 0-7 3.14-7 7s3.14 7 7 7V5z"/></svg> <span class="icon-label">Imagen</span> </button>
    <button class="icon-btn" title="Generar QR" id="generateQrBtn"> <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-6 8h8v-8h-8v8zm2-6h4v4h-4v-4z"/></svg> <span class="icon-label">QR</span> </button>
    <button class="icon-btn" title="Exportar" id="exportBtn"> <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> <span class="icon-label">Exportar</span> </button>
    <button class="icon-btn" title="Limpiar todo" id="clearCanvasBtn"> <svg viewBox="0 0 24 24"><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4zM6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12z"/></svg> <span class="icon-label">Limpiar</span> </button>
    <button class="icon-btn" title="Cambiar tema" id="themeToggleBtn"> <svg id="themeIcon" viewBox="0 0 24 24"></svg> <span class="icon-label">Tema</span> </button>
</header>

<main>
    <div class="canvas-wrapper">
        <canvas id="backgroundCanvas"></canvas>
        <div class="canvas-container">
            <canvas id="flyerCanvas"></canvas>
        </div>
    </div>
    <div class="floating-tools" id="floatingTools" style="display:none;">
        <div id="generalTools"> <button id="btnSubirCapa" title="Subir capa">‚Üë</button> <button id="btnBajarCapa" title="Bajar capa">‚Üì</button> <button id="btnEnviarFondo" title="Enviar al fondo">‚§ì</button> <button id="btnEliminar" title="Eliminar">üóë</button> </div>
        <div id="textTools" style="display: none;"> <button id="btnOpenFontPopup" title="Cambiar fuente">Aa</button> <button id="btnOpenTextColorPopup" title="Cambiar color">üé®</button> <button id="btnSetTextBg" title="Fondo de texto">Bg</button> <button id="btnAlinIzq" title="Alinear izquierda">‚öç</button> <button id="btnAlinCen" title="Alinear centro">‚ò∞</button> <button id="btnAlinDer" title="Alinear derecha">‚öç</button> </div>
        <div id="imageTools" style="display: none;"> <button id="btnApplyFilter" title="Aplicar filtro">‚ú®</button> <button id="btnRemoveFilters" title="Quitar filtros">üö´</button> </div>
    </div>
    <div class="help-message" id="helpMessage">¬°Puedes mover, rotar y escalar los objetos!</div>
    <button id="resetViewBtn">Restaurar Vista</button>
    <button id="tutorialBtn" title="Ver Tutorial">?</button>
</main>

<div class="popup" id="bgPopup"> <div class="popup-content"> <div class="popup-title">Elige tu Fondo</div> <div class="popup-options"> <button id="pickColorBtn">üé® Elegir un Color</button> </div> <hr style="border: none; border-top: 1px solid var(--border); margin: 0 0 20px;"> <p style="text-align: center; color: var(--text-secondary); margin-bottom: 16px;">O selecciona un fondo predise√±ado:</p> <div class="image-grid" id="bgGrid"></div> <button class="popup-close">Cerrar</button> </div> </div>
<div class="popup" id="imgGalleryPopup"> <div class="popup-content"> <div class="popup-title">A√±adir Imagen</div> <div class="search-wrapper"> <input type="text" id="imageSearchInput" placeholder="Busca en la galer√≠a online (ej: 'fiesta')"> <button id="imageSearchBtn">Buscar</button> </div> <label for="imgLocalInput" class="upload-card"> <span>‚¨ÜÔ∏è</span> Subir tu propia imagen <br><small>o arr√°strala aqu√≠</small></label> <div class="image-grid" id="imgFondoGrid"></div> <button class="popup-close">Cerrar</button> </div> </div>
<div class="popup" id="fontPopup"> <div class="popup-content"> <div class="popup-title">Seleccionar fuente</div> <div id="customFontSelector" class="font-selector"></div> <button class="popup-close">Aplicar</button> </div> </div>
<div class="popup" id="exportPopup"> <div class="popup-content"> <div class="popup-title">Exportar Flyer</div> <button class="popup-close" id="btnDescargarJPG">Descargar como JPG</button> <button class="popup-close" id="btnDescargarPDF" style="margin-top: 10px;">Descargar como PDF</button> </div> </div>
<div class="popup" id="ideasPopup"> <div class="popup-content"> <div class="popup-title">üí° Ideas para tu Pr√≥ximo Dise√±o</div> <ol id="ideas-list"> <li>Anuncios de eventos locales como ferias o festivales.</li> <li>Flyers para clases o talleres que est√©s ofreciendo.</li> <li>Promociones de negocios locales, como descuentos o inauguraciones.</li> <li>Anuncios de servicios profesionales, como asesor√≠as o consultor√≠as.</li> <li>Carteles de b√∫squeda de mascotas perdidas o encontrados.</li> <li>Invitaciones para eventos especiales, como bodas o cumplea√±os.</li> <li>Anuncios de conciertos o presentaciones de bandas.</li> <li>Promociones de productos nuevos o en oferta.</li> <li>Anuncios de talleres de arte o cursos creativos.</li> <li>Carteles de recaudaci√≥n de fondos para causas ben√©ficas.</li> <li>Flyers para actividades deportivas, como clases de yoga o torneos.</li> <li>Anuncios de servicios de catering o comida a domicilio.</li> <li>Promociones de spas o servicios de bienestar.</li> <li>Anuncios de ofertas en tiendas o comercios locales.</li> <li>Carteles de eventos de networking o encuentros profesionales.</li> <li>Anuncios de clases de idiomas o talleres de aprendizaje.</li> <li>Flyers de servicios de fotograf√≠a o videograf√≠a.</li> <li>Promociones de eventos de temporada, como Navidad o Halloween.</li> <li>Anuncios de servicios de limpieza o mantenimiento.</li> <li>Carteles para campa√±as de concientizaci√≥n sobre temas importantes.</li> </ol> <button class="popup-close">Cerrar</button> </div> </div>

<input type="file" id="imgLocalInput" accept="image/*" class="hidden-input">
<input type="color" id="hiddenColorPicker" class="hidden-input">
<div id="dragDropOverlay"></div>

<footer> <div>Hecho con üíú por OtroMundo</div> <div class="footer-links"> <a href="https://unaleotromundo.github.io/otromundo/" target="_blank">GitHub</a> <a href="https://wa.me/59894691690?text=Hola%20%F0%9F%91%8B%20Quisiera%20informaci%C3%B3n">Contacto</a> </div> </footer>

<script>
// --- CONFIGURACI√ìN ---
const UNSPLASH_ACCESS_KEY = 'Xj3SNeQvEW2iW-s3L0vLZgBGrve7ZUFVUGPF_hXLjFI';
const PREDESIGNED_BACKGROUNDS = [ 'https://images.unsplash.com/photo-1553095066-5014bc7b7f2d?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600', 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600', 'https://images.unsplash.com/photo-1513151233558-d860c5398176?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600', 'https://images.unsplash.com/photo-1500462918059-b1a0cb512f1d?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600', 'https://images.unsplash.com/photo-1563291074-2bf8677a69c2?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600', 'https://images.unsplash.com/photo-1487088678257-3a541e6e3922?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600' ];
const fontFamilies = { "Montserrat": "'Montserrat', Arial, sans-serif", "Bebas Neue": "'Bebas Neue', Arial, sans-serif", "Anton": "'Anton', Arial, sans-serif", "Archivo Black": "'Archivo Black', Arial, sans-serif", "Oswald": "'Oswald', Arial, sans-serif", "Poppins": "'Poppins', Arial, sans-serif", "Lobster": "'Lobster', cursive", "Playfair Display": "'Playfair Display', serif", "Permanent Marker": "'Permanent Marker', cursive", "Rock Salt": "'Rock Salt', cursive", "Luckiest Guy": "'Luckiest Guy', cursive", "Shadows Into Light": "'Shadows Into Light', cursive", "Orbitron": "'Orbitron', sans-serif", "Quicksand": "'Quicksand', Arial, sans-serif", "Arizonia": "'Arizonia', cursive", "Bangers": "'Bangers', cursive", "Covered By Your Grace": "'Covered By Your Grace', cursive", "Fredericka the Great": "'Fredericka the Great', cursive", "Indie Flower": "'Indie Flower', cursive", "Pacifico": "'Pacifico', cursive", "Press Start 2P": "'Press Start 2P', monospace", "Gloria Hallelujah": "'Gloria Hallelujah', cursive", "Rammetto One": "'Rammetto One', cursive", "Monoton": "'Monoton', cursive", "Rubik Moonrocks": "'Rubik Moonrocks', cursive", "Special Elite": "'Special Elite', monospace", "Amatic SC": "'Amatic SC', cursive", "VT323": "'VT323', monospace", "Chewy": "'Chewy', cursive", "Black Ops One": "'Black Ops One', cursive", "Faster One": "'Faster One', cursive", "Acme": "'Acme', sans-serif", "Rye": "'Rye', cursive", "Rubik 80s Fade": "'Rubik 80s Fade', cursive", "Sigmar One": "'Sigmar One', cursive", "UnifrakturCook": "'UnifrakturCook', cursive", "Sacramento": "'Sacramento', cursive", "Chango": "'Chango', cursive", "Major Mono Display": "'Major Mono Display', monospace", "IBM Plex Mono": "'IBM Plex Mono', monospace", "Poiret One": "'Poiret One', cursive", "Unbounded": "'Unbounded', sans-serif" };

const backgroundCanvas = new fabric.StaticCanvas('backgroundCanvas', { renderOnAddRemove: false });
const canvas = new fabric.Canvas('flyerCanvas', { preserveObjectStacking: true, selection: true, allowTouchScrolling: true, enableRetinaScaling: true, devicePixelRatio: window.devicePixelRatio || 1, selectionColor: 'rgba(0, 180, 216, 0.3)', selectionBorderColor: 'rgba(0, 180, 216, 0.8)', selectionLineWidth: 2, hoverCursor: 'move', defaultCursor: 'default' });
fabric.Textbox.prototype.textBaseline = 'alphabetic';

// --- FUNCIONES B√ÅSICAS ---
async function searchUnsplashImages(query) { if (!UNSPLASH_ACCESS_KEY || UNSPLASH_ACCESS_KEY === 'TU_CLAVE_DE_API_DE_UNSPLASH') { alert('Por favor, configura tu clave de API de Unsplash en el script.'); return; } const imgGrid = document.getElementById('imgFondoGrid'); imgGrid.innerHTML = '<p>Buscando im√°genes...</p>'; try { const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=12&client_id=${UNSPLASH_ACCESS_KEY}`); if (!response.ok) throw new Error(`Error de Unsplash: ${response.statusText}`); const data = await response.json(); imgGrid.innerHTML = ''; if (data.results.length === 0) { imgGrid.innerHTML = '<p>No se encontraron resultados. Intenta otra b√∫squeda.</p>'; return; } data.results.forEach(photo => { const img = document.createElement("img"); img.src = photo.urls.small; img.className = "image-thumb"; img.alt = photo.alt_description; img.addEventListener("click", () => addImageToCanvas(photo.urls.regular)); imgGrid.appendChild(img); }); } catch(error) { console.error("Error al buscar im√°genes:", error); imgGrid.innerHTML = `<p>Error al cargar im√°genes. Revisa la consola.</p>`; } }
async function loadAndApplyFont(fontName, fontFamily) { if (document.fonts.check(`1em "${fontName}"`)) { applyFont(fontFamily, fontName); return; } showHelpMessage(`Cargando fuente: ${fontName}...`, 1500); const link = document.createElement('link'); const formattedFontName = fontName.replace(/ /g, '+'); link.href = `https://fonts.googleapis.com/css2?family=${formattedFontName}:wght@400;700&display=swap`; link.rel = 'stylesheet'; document.head.appendChild(link); link.onload = () => applyFont(fontFamily); }
function applyFont(fontFamily) { const active = canvas.getActiveObject(); if (active && active.type === "textbox") { active.set("fontFamily", fontFamily); canvas.renderAll(); } }
function addImageToCanvas(url) { fabric.Image.fromURL(url, (img) => { const scale = Math.min((canvas.width * 0.6) / img.width, (canvas.height * 0.6) / img.height); img.scale(scale).set({ left: canvas.width / 2, top: canvas.height / 2, originX: "center", originY: "center", hasControls: true, crossOrigin: 'anonymous' }); canvas.add(img).setActiveObject(img).renderAll(); showHelpMessage("Imagen agregada.", 3000); document.getElementById('imgGalleryPopup').style.display = 'none'; }, { crossOrigin: 'anonymous' }); }
function adjustCanvasSize() { const wrapper = document.querySelector('.canvas-wrapper'); const main = document.querySelector('main'); const aspectRatio = 800 / 1066; let newWidth = main.clientWidth * 0.95; let newHeight = newWidth / aspectRatio; if (newHeight > main.clientHeight * 0.95) { newHeight = main.clientHeight * 0.95; newWidth = newHeight * aspectRatio; } wrapper.style.width = `${newWidth}px`; wrapper.style.height = `${newHeight}px`; canvas.setWidth(newWidth).setHeight(newHeight).renderAll(); backgroundCanvas.setWidth(newWidth).setHeight(newHeight).renderAll(); setCanvasBackgroundColor('#ffffff'); }
function showHelpMessage(message, duration = 4000) { const helpElement = document.getElementById('helpMessage'); helpElement.textContent = message; helpElement.style.display = 'block'; helpElement.style.animation = 'none'; void helpElement.offsetWidth; helpElement.style.animation = `fadeInOut ${duration / 1000}s forwards`; }
function renderFontOptions() { const container = document.getElementById("customFontSelector"); if (container.children.length > 0) return; Object.keys(fontFamilies).forEach(fontName => { const div = document.createElement("div"); div.className = "font-option"; div.textContent = fontName; div.style.fontFamily = fontFamilies[fontName] || fontName; div.addEventListener("click", () => { document.querySelectorAll('.font-option').forEach(o => o.classList.remove('selected')); div.classList.add('selected'); loadAndApplyFont(fontName, fontFamilies[fontName] || fontName); }); container.appendChild(div); }); }

// --- EVENT LISTENERS GENERALES ---
window.addEventListener('load', () => { adjustCanvasSize(); loadCanvasState(); enterSelectMode(); });
window.addEventListener('resize', adjustCanvasSize);
document.getElementById('addImageBtn').addEventListener('click', () => { document.getElementById('imgGalleryPopup').style.display = 'flex'; document.getElementById('imgFondoGrid').innerHTML = ''; });
document.getElementById('imgLocalInput').addEventListener('change', function(e) { if (!e.target.files || !e.target.files[0]) return; const reader = new FileReader(); reader.onload = (event) => addImageToCanvas(event.target.result); reader.readAsDataURL(e.target.files[0]); e.target.value = ""; });
document.getElementById('addTextBtn').addEventListener('click', () => { const textObj = new fabric.Textbox("Tu texto aqu√≠", { left: canvas.width / 2, top: canvas.height / 2, fontSize: 40, fill: '#333', fontFamily: fontFamilies["Montserrat"], originX: "center", originY: "center", editable: true, width: canvas.width * 0.8, textAlign: 'center' }); canvas.add(textObj).setActiveObject(textObj).renderAll(); });
document.getElementById('generateQrBtn').addEventListener('click', () => { const tel = prompt("Ingresa n√∫mero de WhatsApp (ej: 094123456):", ""); if (tel && tel.match(/^\d{6,}$/)) { const url = `https://wa.me/598${tel}?text=¬°Hola!%20Vi%20tu%20flyer%20y%20me%20interesa%20saber%20m√°s`; const qr = new QRious({ value: url, size: 300 }); addImageToCanvas(qr.toDataURL()); } else { alert("Por favor, ingresa un n√∫mero de WhatsApp v√°lido."); } });
document.getElementById('exportBtn').addEventListener('click', () => document.getElementById('exportPopup').style.display = 'flex');
document.querySelectorAll('.popup-close').forEach(btn => btn.addEventListener('click', () => btn.closest('.popup').style.display = 'none'));
document.getElementById('btnDescargarJPG').addEventListener('click', () => { prepareAndExport('jpeg'); });
document.getElementById('btnDescargarPDF').addEventListener('click', () => { prepareAndExport('pdf'); });
const floatingTools = document.getElementById('floatingTools'), textTools = document.getElementById('textTools'), imageTools = document.getElementById('imageTools');
const updateTools = (e) => { const target = e?.selected?.[0]; floatingTools.style.display = target ? 'flex' : 'none'; if (target) { textTools.style.display = target.type === 'textbox' ? 'flex' : 'none'; imageTools.style.display = target.type === 'image' ? 'flex' : 'none'; } };
canvas.on({'selection:created': updateTools, 'selection:updated': updateTools, 'selection:cleared': updateTools});
document.getElementById('btnSubirCapa').addEventListener('click', () => { const obj = canvas.getActiveObject(); if(obj) { canvas.bringForward(obj); canvas.renderAll(); saveState(); }});
document.getElementById('btnBajarCapa').addEventListener('click', () => { const obj = canvas.getActiveObject(); if(obj) { canvas.sendBackwards(obj); canvas.renderAll(); saveState(); }});
document.getElementById('btnEnviarFondo').addEventListener('click', () => { const obj = canvas.getActiveObject(); if(obj) { canvas.sendToBack(obj); canvas.renderAll(); saveState(); }});
document.getElementById('btnEliminar').addEventListener('click', () => { canvas.getActiveObjects().forEach(obj => canvas.remove(obj)); canvas.discardActiveObject().renderAll(); });
document.getElementById('btnAlinIzq').addEventListener('click', () => { canvas.getActiveObject()?.set("textAlign", "left").setCoords(); canvas.renderAll(); saveState(); });
document.getElementById('btnAlinCen').addEventListener('click', () => { canvas.getActiveObject()?.set("textAlign", "center").setCoords(); canvas.renderAll(); saveState(); });
document.getElementById('btnAlinDer').addEventListener('click', () => { canvas.getActiveObject()?.set("textAlign", "right").setCoords(); canvas.renderAll(); saveState(); });
document.getElementById('btnOpenFontPopup').addEventListener('click', () => { renderFontOptions(); document.getElementById('fontPopup').style.display = 'flex'; });
document.getElementById('btnOpenTextColorPopup').addEventListener('click', () => { const active = canvas.getActiveObject(); if (active?.type === 'textbox') { const picker = document.createElement('input'); picker.type = 'color'; picker.value = active.fill; picker.oninput = () => { active.set("fill", picker.value); canvas.renderAll(); }; picker.onchange = () => saveState(); picker.click(); } });
document.getElementById('imageSearchBtn').addEventListener('click', () => { const query = document.getElementById('imageSearchInput').value; if(query.trim()) searchUnsplashImages(query); });
document.getElementById('imageSearchInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') searchUnsplashImages(e.target.value); });
const filters = [ new fabric.Image.filters.Grayscale(), new fabric.Image.filters.Sepia(), new fabric.Image.filters.Invert(), new fabric.Image.filters.Vintage(), new fabric.Image.filters.Kodachrome(), new fabric.Image.filters.Technicolor(), new fabric.Image.filters.Brownie(), new fabric.Image.filters.Polaroid(), new fabric.Image.filters.Brightness({ brightness: 0.2 }), new fabric.Image.filters.Contrast({ contrast: 0.2 }) ];
let currentFilterIndex = 0;
document.getElementById('btnApplyFilter').addEventListener('click', () => { const obj = canvas.getActiveObject(); if (obj?.type === 'image') { currentFilterIndex = (currentFilterIndex + 1) % filters.length; obj.filters = [filters[currentFilterIndex]]; obj.applyFilters(); canvas.renderAll(); saveState(); } });
document.getElementById('btnRemoveFilters').addEventListener('click', () => { const obj = canvas.getActiveObject(); if (obj?.type === 'image') { obj.filters = []; obj.applyFilters(); canvas.renderAll(); saveState(); } });
function updateToggleIcon() { const icon = document.getElementById('themeIcon'); if (document.body.classList.contains('dark')) { icon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>'; } else { icon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>'; } }
function toggleTheme() { document.body.classList.toggle('dark'); localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light'); updateToggleIcon(); canvas.renderAll(); }
const savedTheme = localStorage.getItem('theme'); if (savedTheme === 'dark') { document.body.classList.add('dark'); }
updateToggleIcon();
document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);

// --- L√ìGICA DEL TUTORIAL Y BIENVENIDA ---
const welcomeOverlay = document.getElementById('welcomeOverlay'), startEditingBtn = document.getElementById('startEditingBtn'), showIdeasBtn = document.getElementById('showIdeasBtn'), ideasPopup = document.getElementById('ideasPopup'), tutorialBtn = document.getElementById('tutorialBtn');
window.addEventListener('load', () => { if (!localStorage.getItem('tutorialShown')) { welcomeOverlay.style.display = 'flex'; } });
startEditingBtn.addEventListener('click', () => { welcomeOverlay.style.display = 'none'; localStorage.setItem('tutorialShown', 'true'); });
showIdeasBtn.addEventListener('click', () => { welcomeOverlay.style.display = 'none'; ideasPopup.style.display = 'flex'; localStorage.setItem('tutorialShown', 'true'); });
tutorialBtn.addEventListener('click', () => { welcomeOverlay.style.display = 'flex'; });

// --- L√ìGICA DE FONDOS REESTRUCTURADA ---
const hiddenColorPicker = document.getElementById('hiddenColorPicker');
function setCanvasBackgroundFromUrl(url) { fabric.Image.fromURL(url, (img) => { backgroundCanvas.setBackgroundImage(img, backgroundCanvas.renderAll.bind(backgroundCanvas), { scaleX: backgroundCanvas.width / img.width, scaleY: backgroundCanvas.height / img.height, selectable: false, evented: false }); document.getElementById('bgPopup').style.display = 'none'; saveState(); }, { crossOrigin: 'anonymous' }); }
function setCanvasBackgroundColor(color) { backgroundCanvas.setBackgroundImage(null, backgroundCanvas.renderAll.bind(backgroundCanvas)); backgroundCanvas.setBackgroundColor(color, backgroundCanvas.renderAll.bind(backgroundCanvas)); }
function renderBackgroundOptions() { const bgGrid = document.getElementById('bgGrid'); if (bgGrid.children.length > 0) return; PREDESIGNED_BACKGROUNDS.forEach(url => { const img = document.createElement("img"); img.src = url; img.className = "image-thumb"; img.addEventListener("click", () => setCanvasBackgroundFromUrl(url)); bgGrid.appendChild(img); }); }
document.getElementById('bgColorBtn').addEventListener('click', () => { renderBackgroundOptions(); document.getElementById('bgPopup').style.display = 'flex'; });
document.getElementById('pickColorBtn').addEventListener('click', () => { document.getElementById('bgPopup').style.display = 'none'; hiddenColorPicker.value = backgroundCanvas.backgroundColor; hiddenColorPicker.click(); });
hiddenColorPicker.addEventListener('input', () => { setCanvasBackgroundColor(hiddenColorPicker.value); });

// --- L√ìGICA DE ARRASTRAR Y SOLTAR ---
const dragDropOverlay = document.getElementById('dragDropOverlay');
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { window.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false); });
let dragCounter = 0;
window.addEventListener('dragenter', () => { dragCounter++; dragDropOverlay.style.display = 'flex' });
window.addEventListener('dragleave', () => { dragCounter--; if (dragCounter === 0) { dragDropOverlay.style.display = 'none'; } });
window.addEventListener('drop', (e) => { dragDropOverlay.style.display = 'none'; dragCounter = 0; const files = e.dataTransfer.files; if (files.length > 0) { const file = files[0]; if (file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (event) => addImageToCanvas(event.target.result); reader.readAsDataURL(file); } } });

// --- SISTEMA DE ZOOM ---
let currentMode = 'select';
const zoomModeBtn = document.getElementById('zoomModeBtn'), resetViewBtn = document.getElementById('resetViewBtn');
function enterSelectMode() { currentMode = 'select'; canvas.selection = true; canvas.defaultCursor = 'default'; canvas.hoverCursor = 'move'; canvas.getObjects().forEach(obj => obj.selectable = true); zoomModeBtn.classList.remove('active'); canvas.discardActiveObject().renderAll(); }
function enterZoomMode() { currentMode = 'zoom'; canvas.selection = false; canvas.defaultCursor = 'crosshair'; canvas.hoverCursor = 'crosshair'; canvas.getObjects().forEach(obj => obj.selectable = false); zoomModeBtn.classList.add('active'); canvas.discardActiveObject().renderAll(); }
function resetCanvasView() { canvas.setViewportTransform([1, 0, 0, 1, 0, 0]); resetViewBtn.style.display = 'none'; canvas.renderAll(); }
zoomModeBtn.addEventListener('click', () => { if (currentMode === 'zoom') { enterSelectMode(); } else { enterZoomMode(); } });
resetViewBtn.addEventListener('click', resetCanvasView);
canvas.on('mouse:down', function(opt) { if (currentMode === 'zoom') { const pointer = canvas.getPointer(opt.e); const zoom = opt.e.altKey ? canvas.getZoom() / 1.3 : canvas.getZoom() * 1.3; canvas.zoomToPoint(pointer, zoom); resetViewBtn.style.display = 'block'; } });

// --- L√ìGICA DESHACER/REHACER, TECLAS Y FONDO DE TEXTO ---
let undoStack = [], redoStack = [];
const historyLimit = 12;
let isStateAction = false;
const undoBtn = document.getElementById('undoBtn'), redoBtn = document.getElementById('redoBtn');

function updateHistoryButtons() { undoBtn.disabled = undoStack.length <= 1; redoBtn.disabled = redoStack.length === 0; }
function saveState() {
    if (isStateAction) return;
    const jsonState = { canvas: canvas.toJSON(), background: backgroundCanvas.toJSON() };
    try { localStorage.setItem('savedCanvas', JSON.stringify(jsonState)); } catch (error) { console.error('No se pudo guardar el estado del canvas:', error); }
    redoStack = [];
    if (undoStack.length > historyLimit) { undoStack.shift(); }
    undoStack.push(jsonState);
    updateHistoryButtons();
}
function loadState(state) {
    isStateAction = true;
    canvas.loadFromJSON(state.canvas, () => {
        backgroundCanvas.loadFromJSON(state.background, () => {
            canvas.renderAll();
            backgroundCanvas.renderAll();
            isStateAction = false;
            updateHistoryButtons();
        });
    });
}
function undo() { if (undoStack.length > 1) { redoStack.push(undoStack.pop()); const lastState = undoStack[undoStack.length - 1]; loadState(lastState); } }
function redo() { const stateToLoad = redoStack.pop(); if (stateToLoad) { undoStack.push(stateToLoad); loadState(stateToLoad); } }
function loadCanvasState() {
    const savedState = localStorage.getItem('savedCanvas');
    if (savedState) {
        const state = JSON.parse(savedState);
        undoStack = [state];
        loadState(state);
        showHelpMessage("¬°Bienvenido de vuelta!", 3000);
    } else {
        saveState();
    }
}

document.getElementById('clearCanvasBtn').addEventListener('click', () => {
    if(confirm('¬øEst√°s seguro de que quieres borrar todo el dise√±o?')) {
        canvas.clear();
        setCanvasBackgroundColor('#ffffff');
        resetCanvasView();
        saveState();
    }
});

canvas.on({'object:modified': saveState, 'object:added': saveState, 'object:removed': saveState });
hiddenColorPicker.addEventListener('change', saveState);

undoBtn.addEventListener('click', undo);
redoBtn.addEventListener('click', redo);

window.addEventListener('keydown', (e) => {
    if (e.ctrlKey || e.metaKey) {
        if (e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); }
        if (e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); }
        return;
    }
    const activeObject = canvas.getActiveObject();
    if (activeObject && document.activeElement.tagName !== 'INPUT' && !activeObject.isEditing) {
        if (e.key === 'Delete' || e.key === 'Backspace') {
            e.preventDefault();
            canvas.getActiveObjects().forEach(obj => canvas.remove(obj));
            canvas.discardActiveObject().renderAll();
            saveState();
        }
        
        const moveStep = 2;
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
            e.preventDefault();
            canvas.getActiveObjects().forEach(obj => {
                switch (e.key) {
                    case 'ArrowLeft': obj.left -= moveStep; break;
                    case 'ArrowRight': obj.left += moveStep; break;
                    case 'ArrowUp': obj.top -= moveStep; break;
                    case 'ArrowDown': obj.top += moveStep; break;
                }
                obj.setCoords();
            });
            canvas.renderAll();
        }
    }
});
window.addEventListener('keyup', (e) => { if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key) && canvas.getActiveObject() && !canvas.getActiveObject().isEditing) { saveState(); } });

document.getElementById('btnSetTextBg').addEventListener('click', () => {
    const activeObj = canvas.getActiveObject();
    if (activeObj && activeObj.type === 'textbox') {
        const picker = document.createElement('input');
        picker.type = 'color';
        picker.value = activeObj.backgroundColor || '#00000000';
        
        picker.oninput = () => {
            activeObj.set("backgroundColor", picker.value);
            canvas.renderAll();
        };
        picker.onchange = saveState;
        picker.click();
    }
});

function prepareAndExport(format) {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        canvas.discardActiveObject();
        canvas.renderAll();
    }

    const tempCanvasEl = document.createElement('canvas');
    const multiplier = 3;
    tempCanvasEl.width = canvas.width * multiplier;
    tempCanvasEl.height = canvas.height * multiplier;
    const tempCtx = tempCanvasEl.getContext('2d');

    const bgImage = backgroundCanvas.toDataURL({format: 'png', multiplier: multiplier});
    const fgImage = canvas.toDataURL({format: 'png', multiplier: multiplier});

    const bg = new Image();
    bg.onload = () => {
        tempCtx.drawImage(bg, 0, 0);
        const fg = new Image();
        fg.onload = () => {
            tempCtx.drawImage(fg, 0, 0);
            
            const dataUrl = tempCanvasEl.toDataURL({ format: `image/${format}`, quality: 1.0 });

            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: "portrait", unit: "px", format: [canvas.width, canvas.height] });
                pdf.addImage(dataUrl, 'JPEG', 0, 0, canvas.width, canvas.height);
                pdf.save("flyer.pdf");
            } else {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `flyer.${format}`;
                link.click();
            }

            if (activeObject) {
                canvas.setActiveObject(activeObject);
                canvas.renderAll();
            }
        };
        fg.src = fgImage;
    };
    bg.src = bgImage;
}
</script>
</body>
</html>